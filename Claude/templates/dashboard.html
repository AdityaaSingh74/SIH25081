{% extends "base.html" %}

{% block title %}Dashboard - Smart Metro AI OS{% endblock %}
{% block page_title %}AI Dashboard{% endblock %}
{% block page_subtitle %}Real-time monitoring of 25+ trains across KMRL network{% endblock %}

{% block content %}
<!-- Key Performance Metrics -->
<div class="metrics-grid">
    <div class="metric-card primary">
        <div class="metric-header">
            <h3>Scheduling Accuracy</h3>
            <i class="fas fa-clock"></i>
        </div>
        <div class="metric-value">
            <span id="scheduling-accuracy">--.--%</span>
            <span class="metric-change positive" id="accuracy-change">+0.0%</span>
        </div>
        <div class="metric-description">Target: 99.8% (SIH Goal)</div>
    </div>

    <div class="metric-card success">
        <div class="metric-header">
            <h3>Average Delay</h3>
            <i class="fas fa-hourglass-half"></i>
        </div>
        <div class="metric-value">
            <span id="average-delay">-- min</span>
            <span class="metric-change negative" id="delay-change">+0.0 min</span>
        </div>
        <div class="metric-description">Target: <2 min (AI Optimized)</div>
    </div>

    <div class="metric-card info">
        <div class="metric-header">
            <h3>Train Availability</h3>
            <i class="fas fa-subway"></i>
        </div>
        <div class="metric-value">
            <span id="train-availability">--%</span>
            <span class="metric-change positive" id="availability-change">+0%</span>
        </div>
        <div class="metric-description">Active: Running + Ready trains</div>
    </div>

    <div class="metric-card warning">
        <div class="metric-header">
            <h3>Passenger Wait Time</h3>
            <i class="fas fa-users"></i>
        </div>
        <div class="metric-value">
            <span id="passenger-wait-time">-- min</span>
            <span class="metric-change negative" id="wait-change">-0.0 min</span>
        </div>
        <div class="metric-description">Target: 30% reduction</div>
    </div>
</div>

<!-- Real-time Charts Section -->
<div class="dashboard-grid">
    <div class="chart-container">
        <div class="chart-header">
            <h3><i class="fas fa-chart-pie"></i> Train Status Distribution</h3>
            <div class="chart-controls">
                <button class="refresh-btn" onclick="refreshTrainStatus()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>
        <div class="chart-body">
            <canvas id="train-status-chart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3><i class="fas fa-chart-line"></i> Performance Trends (7 Days)</h3>
            <div class="chart-controls">
                <select id="trend-metric" onchange="updateTrendChart()">
                    <option value="accuracy">Scheduling Accuracy</option>
                    <option value="delay">Average Delay</option>
                    <option value="availability">Train Availability</option>
                </select>
            </div>
        </div>
        <div class="chart-body">
            <canvas id="performance-trend-chart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3><i class="fas fa-route"></i> Route Performance Analysis</h3>
            <div class="chart-controls">
                <span class="legend">
                    <span class="legend-item"><span class="legend-color delay"></span>Avg Delay</span>
                    <span class="legend-item"><span class="legend-color trips"></span>Total Trips</span>
                </span>
            </div>
        </div>
        <div class="chart-body">
            <canvas id="route-performance-chart"></canvas>
        </div>
    </div>
</div>

<!-- Live Alerts and Notifications -->
<div class="alerts-section">
    <div class="section-header">
        <h3><i class="fas fa-bell"></i> Live System Alerts</h3>
        <div class="alert-controls">
            <span class="alert-count">Active: <span id="active-alerts">0</span></span>
            <button class="clear-alerts-btn" onclick="clearAllAlerts()">Clear All</button>
        </div>
    </div>
    <div id="alerts-container" class="alerts-container">
        <!-- Alerts will be populated by JavaScript -->
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="quick-actions-panel">
    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
    <div class="actions-grid">
        <button class="action-btn primary" onclick="optimizeSchedule()">
            <i class="fas fa-magic"></i>
            <span>Optimize Schedule</span>
        </button>
        <button class="action-btn success" onclick="deployBackupTrain()">
            <i class="fas fa-plus-circle"></i>
            <span>Deploy Backup</span>
        </button>
        <button class="action-btn warning" onclick="emergencyProtocol()">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Emergency Mode</span>
        </button>
        <button class="action-btn info" onclick="generateReport()">
            <i class="fas fa-file-alt"></i>
            <span>Generate Report</span>
        </button>
    </div>
</div>

<!-- Search Results Modal -->
<div id="search-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Search Results</h3>
            <button class="close-modal" onclick="closeSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="search-results" class="search-results">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard specific JavaScript
let trainStatusChart, performanceTrendChart, routePerformanceChart;
let dashboardData = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDashboardData();
    startRealTimeUpdates();
    setupSearch();
});

function initializeCharts() {
    // Train Status Pie Chart
    const statusCtx = document.getElementById('train-status-chart').getContext('2d');
    trainStatusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Running', 'Ready', 'Held', 'Maintenance'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#00D4AA', '#3B82F6', '#F59E0B', '#EF4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#E5E7EB' }
                }
            }
        }
    });

    // Performance Trend Line Chart
    const trendCtx = document.getElementById('performance-trend-chart').getContext('2d');
    performanceTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Scheduling Accuracy (%)',
                data: [],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#374151' },
                    ticks: { color: '#E5E7EB' }
                },
                x: {
                    grid: { color: '#374151' },
                    ticks: { color: '#E5E7EB' }
                }
            },
            plugins: {
                legend: { labels: { color: '#E5E7EB' } }
            }
        }
    });

    // Route Performance Bar Chart
    const routeCtx = document.getElementById('route-performance-chart').getContext('2d');
    routePerformanceChart = new Chart(routeCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Average Delay (min)',
                    data: [],
                    backgroundColor: '#EF4444',
                    yAxisID: 'y'
                },
                {
                    label: 'Total Trips',
                    data: [],
                    backgroundColor: '#00D4AA',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: '#374151' },
                    ticks: { color: '#E5E7EB' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#E5E7EB' }
                },
                x: {
                    grid: { color: '#374151' },
                    ticks: { color: '#E5E7EB' }
                }
            },
            plugins: {
                legend: { labels: { color: '#E5E7EB' } }
            }
        }
    });
}

async function loadDashboardData() {
    try {
        showLoading();
        const response = await fetch('/api/dashboard_data');
        dashboardData = await response.json();
        
        updateMetrics();
        updateCharts();
        updateAlerts();
        updateLastUpdateTime();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Error loading dashboard data', 'error');
    } finally {
        hideLoading();
    }
}

function updateMetrics() {
    const performance = dashboardData.performance;
    
    document.getElementById('scheduling-accuracy').textContent = 
        (performance.scheduling_accuracy || 0).toFixed(1) + '%';
    document.getElementById('average-delay').textContent = 
        (performance.average_delay || 0).toFixed(1) + ' min';
    document.getElementById('train-availability').textContent = 
        (performance.train_availability || 0).toFixed(0) + '%';
    document.getElementById('passenger-wait-time').textContent = 
        (performance.passenger_wait_time || 0).toFixed(1) + ' min';
    
    // Update change indicators
    updateChangeIndicators(performance);
}

function updateChangeIndicators(performance) {
    // Simulate change calculations (in real system, compare with previous values)
    const changes = {
        accuracy: ((performance.scheduling_accuracy - 95) / 95 * 100).toFixed(1),
        delay: ((performance.average_delay - 3) * -1).toFixed(1),
        availability: ((performance.train_availability - 80) / 80 * 100).toFixed(0),
        wait: ((performance.passenger_wait_time - 5) * -1).toFixed(1)
    };
    
    updateChangeElement('accuracy-change', changes.accuracy, 'positive');
    updateChangeElement('delay-change', changes.delay, 'negative');
    updateChangeElement('availability-change', changes.availability, 'positive');
    updateChangeElement('wait-change', changes.wait, 'negative');
}

function updateChangeElement(elementId, value, preferredDirection) {
    const element = document.getElementById(elementId);
    const isPositive = parseFloat(value) >= 0;
    const isGoodChange = (preferredDirection === 'positive' && isPositive) || 
                        (preferredDirection === 'negative' && !isPositive);
    
    element.className = isGoodChange ? 'metric-change positive' : 'metric-change negative';
    element.textContent = (isPositive ? '+' : '') + value + (elementId.includes('change') ? '%' : '');
}

function updateCharts() {
    // Update train status chart
    if (dashboardData.train_status && dashboardData.train_status.length > 0) {
        const statusData = [0, 0, 0, 0]; // Running, Ready, Held, Maintenance
        dashboardData.train_status.forEach(status => {
            switch(status.status) {
                case 'Running': statusData[0] = status.count; break;
                case 'Ready': statusData[1] = status.count; break;
                case 'Held': statusData[2] = status.count; break;
                case 'Maintenance': statusData[3] = status.count; break;
            }
        });
        
        trainStatusChart.data.datasets[0].data = statusData;
        trainStatusChart.update('none');
    }
    
    // Update route performance chart
    if (dashboardData.route_performance && dashboardData.route_performance.length > 0) {
        const routes = dashboardData.route_performance.map(r => r.route);
        const delays = dashboardData.route_performance.map(r => r.avg_delay);
        const trips = dashboardData.route_performance.map(r => r.trips);
        
        routePerformanceChart.data.labels = routes;
        routePerformanceChart.data.datasets[0].data = delays;
        routePerformanceChart.data.datasets[1].data = trips;
        routePerformanceChart.update('none');
    }
}

function updateAlerts() {
    const alertsContainer = document.getElementById('alerts-container');
    const alerts = dashboardData.alerts || [];
    
    if (alerts.length === 0) {
        alertsContainer.innerHTML = '<div class="no-alerts">No active alerts - All systems operating normally</div>';
    } else {
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert alert-${alert.type}">
                <div class="alert-icon">
                    <i class="fas fa-${getAlertIcon(alert.type)}"></i>
                </div>
                <div class="alert-content">
                    <h4>${alert.title}</h4>
                    <p>${alert.message}</p>
                    <span class="alert-time">${formatTime(alert.timestamp)}</span>
                </div>
                <button class="alert-dismiss" onclick="dismissAlert('${alert.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
    
    document.getElementById('active-alerts').textContent = alerts.length;
}

function getAlertIcon(type) {
    const icons = {
        'info': 'info-circle',
        'warning': 'exclamation-triangle',
        'error': 'exclamation-circle',
        'success': 'check-circle'
    };
    return icons[type] || 'info-circle';
}

function updateLastUpdateTime() {
    const now = new Date();
    document.getElementById('last-update-time').textContent = 
        now.toLocaleTimeString('en-US', { hour12: false });
}

function startRealTimeUpdates() {
    // Update every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Update time display every second
    setInterval(updateLastUpdateTime, 1000);
}

function setupSearch() {
    const searchInput = document.getElementById('global-search');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => performSearch(query), 300);
        } else {
            closeSearchModal();
        }
    });
}

async function performSearch(query) {
    try {
        const response = await fetch(`/api/search_trains?query=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        displaySearchResults(results);
    } catch (error) {
        console.error('Search error:', error);
    }
}

function displaySearchResults(results) {
    const modal = document.getElementById('search-modal');
    const resultsContainer = document.getElementById('search-results');
    
    if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">No trains found matching your search</div>';
    } else {
        resultsContainer.innerHTML = results.map(train => `
            <div class="search-result-item" onclick="viewTrainDetails('${train.train_id}')">
                <div class="result-header">
                    <h4>${train.train_id}</h4>
                    <span class="status-badge status-${train.status.toLowerCase()}">${train.status}</span>
                </div>
                <div class="result-details">
                    <p><i class="fas fa-route"></i> ${train.route} | <i class="fas fa-warehouse"></i> ${train.depot}</p>
                    <p><i class="fas fa-users"></i> Load: ${train.passenger_load} | <i class="fas fa-gauge"></i> Readiness: ${(train.readiness_score * 100).toFixed(1)}%</p>
                </div>
            </div>
        `).join('');
    }
    
    modal.style.display = 'flex';
}

// Quick Action Functions
async function optimizeSchedule() {
    showLoading();
    showNotification('Optimizing schedule using AI algorithms...', 'info');
    
    // Simulate optimization (in real system, call optimization API)
    setTimeout(() => {
        hideLoading();
        showNotification('Schedule optimization completed! 15% improvement in efficiency.', 'success');
        loadDashboardData(); // Refresh data
    }, 3000);
}

async function deployBackupTrain() {
    showLoading();
    
    try {
        // In real system, call backup deployment API
        showNotification('Analyzing available backup trains...', 'info');
        
        setTimeout(() => {
            hideLoading();
            showNotification('Backup train KMRL-025 deployed on Red Line. ETA: 8 minutes.', 'success');
            loadDashboardData();
        }, 2000);
    } catch (error) {
        hideLoading();
        showNotification('Failed to deploy backup train', 'error');
    }
}

function emergencyProtocol() {
    if (confirm('Activate emergency protocol? This will prioritize safety measures and may affect normal operations.')) {
        showNotification('Emergency protocol activated. Switching to safety-first mode.', 'warning');
        // Redirect to emergency management page
        window.location.href = '/emergency';
    }
}

function generateReport() {
    showNotification('Generating comprehensive system report...', 'info');
    
    // Simulate report generation
    setTimeout(() => {
        const reportData = {
            timestamp: new Date().toISOString(),
            metrics: dashboardData.performance,
            train_count: dashboardData.train_status?.reduce((sum, status) => sum + status.count, 0) || 0
        };
        
        const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `metro-report-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Report downloaded successfully', 'success');
    }, 1500);
}

// Utility Functions
function refreshTrainStatus() {
    loadDashboardData();
    showNotification('Train status refreshed', 'info');
}

function updateTrendChart() {
    const metric = document.getElementById('trend-metric').value;
    // Update chart based on selected metric
    showNotification(`Updating trend chart for ${metric}`, 'info');
}

function clearAllAlerts() {
    dashboardData.alerts = [];
    updateAlerts();
    showNotification('All alerts cleared', 'info');
}

function dismissAlert(alertId) {
    dashboardData.alerts = dashboardData.alerts.filter(alert => alert.id !== alertId);
    updateAlerts();
}

function closeSearchModal() {
    document.getElementById('search-modal').style.display = 'none';
}

function viewTrainDetails(trainId) {
    closeSearchModal();
    window.location.href = `/trains?train=${trainId}`;
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString();
}
</script>
{% endblock %}